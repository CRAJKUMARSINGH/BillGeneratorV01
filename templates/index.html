<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infrastructure Billing System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="header-container text-center py-5 mb-5">
            <div class="container">
                <div class="balloon-container">
                    <div class="balloon balloon1">üéà</div>
                    <div class="balloon balloon2">üéà</div>
                    <div class="balloon balloon3">üéà</div>
                </div>
                <h1 class="header-title">üèóÔ∏è Infrastructure Billing System</h1>
                <p class="header-subtitle">Generate professional billing documents from Excel files automatically</p>
                <p class="header-professional">Streamlined infrastructure documentation with statutory compliance and automated calculations</p>
                <p class="header-initiative">An Initiative by Mrs. Premlata Jain, Additional Administrative Officer, PWD, Udaipur</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <div class="row">
                <!-- Upload Section -->
                <div class="col-lg-8">
                    <div class="upload-card">
                        <h3 class="text-primary mb-3">üìÅ Upload Excel File</h3>
                        <p class="text-muted mb-4">
                            Upload your Excel file containing Title, Work Order, Bill Quantity, and Extra Items sheets
                        </p>
                        
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="fileInput" name="file" accept=".xlsx,.xls" required>
                                <div class="form-text">Select an Excel file with the required sheets: Title, Work Order, Bill Quantity, Extra Items (optional)</div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="uploadBtn">
                                <i class="fas fa-upload me-2"></i>Generate Documents
                            </button>
                        </form>

                        <!-- Progress Section -->
                        <div id="progressSection" class="mt-4" style="display: none;">
                            <div class="progress mb-3">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="statusText" class="text-center">Processing...</div>
                        </div>

                        <!-- Results Section -->
                        <div id="resultsSection" class="mt-4" style="display: none;">
                            <div class="alert alert-success">
                                <h5><i class="fas fa-check-circle me-2"></i>Success!</h5>
                                <p id="successMessage"></p>
                                <div id="downloadSection" class="mt-3">
                                    <!-- Download button will be inserted here -->
                                </div>
                            </div>
                        </div>

                        <!-- Error Section -->
                        <div id="errorSection" class="mt-4" style="display: none;">
                            <div class="alert alert-danger">
                                <h5><i class="fas fa-exclamation-circle me-2"></i>Error</h5>
                                <p id="errorMessage"></p>
                                <div id="errorDetails" class="mt-2 small text-muted"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Section -->
                <div class="col-lg-4">
                    <div class="info-card mb-4">
                        <h4 class="text-secondary mb-3">üìã File Requirements</h4>
                        <div class="feature-list">
                            <div class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span><strong>Title Sheet:</strong> Contains all metadata</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span><strong>Work Order:</strong> Original work items</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span><strong>Bill Quantity:</strong> Actual measurements</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span><strong>Extra Items:</strong> Additional work (optional)</span>
                            </div>
                        </div>
                    </div>

                    <div class="info-card">
                        <h4 class="text-secondary mb-3">üìÑ Output Formats</h4>
                        <div class="feature-list">
                            <div class="feature-item">
                                <span class="feature-icon">üìÑ</span>
                                <span>Individual PDF, Word, HTML</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon">üìë</span>
                                <span>Combined PDF document</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon">üóÇÔ∏è</span>
                                <span>Complete ZIP package</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions Section -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="instructions-container">
                        <h2 class="how-to-title">üéØ How to Use This System</h2>
                        <p class="how-to-subtitle">Simple steps to generate your billing documents in minutes!</p>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="simple-step-card">
                                    <div class="simple-step-icon">üìÅ</div>
                                    <h3 class="simple-step-title">Step 1: Upload</h3>
                                    <p class="simple-step-desc">Just drag & drop your Excel file or click to browse</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="simple-step-card">
                                    <div class="simple-step-icon">‚ö°</div>
                                    <h3 class="simple-step-title">Step 2: Wait</h3>
                                    <p class="simple-step-desc">System automatically creates all your documents</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="simple-step-card">
                                    <div class="simple-step-icon">üì•</div>
                                    <h3 class="simple-step-title">Step 3: Download</h3>
                                    <p class="simple-step-desc">Get all documents in one convenient package</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressSection = document.getElementById('progressSection');
            const resultsSection = document.getElementById('resultsSection');
            const errorSection = document.getElementById('errorSection');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            
            // Hide previous results
            resultsSection.style.display = 'none';
            errorSection.style.display = 'none';
            
            if (!fileInput.files[0]) {
                showError('Please select a file to upload.');
                return;
            }
            
            // Show progress
            progressSection.style.display = 'block';
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            
            // Simulate progress updates
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
                
                if (progress < 30) statusText.textContent = 'Analyzing Excel file structure...';
                else if (progress < 60) statusText.textContent = 'Generating professional documents...';
                else if (progress < 80) statusText.textContent = 'Converting to PDF format...';
                else statusText.textContent = 'Creating download package...';
            }, 200);
            
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                statusText.textContent = 'Complete!';
                
                if (response.ok && result.success) {
                    showSuccess(result);
                } else {
                    showError(result.message || result.error, result.details);
                }
                
            } catch (error) {
                clearInterval(progressInterval);
                showError('Network error occurred. Please try again.', error.message);
            }
            
            // Reset button
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Generate Documents';
            
            setTimeout(() => {
                progressSection.style.display = 'none';
            }, 2000);
        });
        
        function showSuccess(result) {
            const resultsSection = document.getElementById('resultsSection');
            const successMessage = document.getElementById('successMessage');
            const downloadSection = document.getElementById('downloadSection');
            
            successMessage.innerHTML = `
                Documents generated successfully in ${result.processing_time}s!<br>
                <small class="text-muted">Package size: ${(result.file_size / (1024*1024)).toFixed(2)} MB</small>
            `;
            
            downloadSection.innerHTML = `
                <a href="${result.download_url}" class="btn btn-success btn-lg">
                    <i class="fas fa-download me-2"></i>Download Complete Package
                </a>
                <div class="mt-2">
                    <small class="text-muted">Filename: ${result.filename}</small>
                </div>
            `;
            
            resultsSection.style.display = 'block';
        }
        
        function showError(message, details = '') {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            const errorDetails = document.getElementById('errorDetails');
            
            errorMessage.textContent = message;
            errorDetails.textContent = details;
            
            errorSection.style.display = 'block';
        }
    </script>
</body>
</html>
