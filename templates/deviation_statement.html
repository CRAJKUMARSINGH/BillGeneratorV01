<html>
<head>
    <title>Deviation Statement</title>
    <style>
        @page { size: A4 landscape; margin: 10mm; }
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; font-size: 9pt; margin: 0; }
        h1 { text-align: center; margin: 0 0 8px 0; font-size: 14pt; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 8.5pt; }
        thead { display: table-header-group; }
        tr { break-inside: avoid; }
        th, td { border: 1px solid #000; padding: 3px; text-align: left; vertical-align: top; word-wrap: break-word; }
        th { background: #f0f0f0; text-align: center; }
    </style>
</head>
<body>
    <h1>DEVIATION STATEMENT</h1>

    <p><strong>Agreement No:</strong> {{ title_data.get('Agreement No :', 'N/A') }}</p>
    <p><strong>Name of Work:</strong> {{ title_data.get('Name of Work ;-', 'N/A') }}</p>
    <p><strong>Name of Firm:</strong> {{ title_data.get('Name of Contractor or supplier :', 'N/A') }}</p>
    <p><strong>Date of Commencement:</strong> {{ title_data.get('Date of commencement  :', 'N/A') }}</p>
    <p><strong>Schedule Date of Completion:</strong> {{ title_data.get('Schedule Date of completion  :', 'N/A') }}</p>
    <p><strong>Actual Date of Completion:</strong> {{ title_data.get('Actual date of completion  :', 'N/A') }}</p>

    <table>
        <tr>
            <th width="6mm">Item No.</th>
            <th width="95mm">Item of Work</th>
            <th width="10mm">Unit</th>
            <th width="10mm">Qty as per Work Order</th>
            <th width="12mm">Rate</th>
            <th width="12mm">Amount as per Work Order</th>
            <th width="12mm">Qty as Executed</th>
            <th width="12mm">Amount as Executed</th>
            <th width="12mm">Excess Qty</th>
            <th width="12mm">Excess Amount</th>
            <th width="12mm">Saving Qty</th>
            <th width="12mm">Saving Amount</th>
            <th width="40mm">Remark</th>
        </tr>
        {% for item in work_items %}
        <tr>
            <td>{{ item.serial_no if item.serial_no and item.serial_no != 'nan' else '' }}</td>
            <td>{{ item.description }}</td>
            <td>{{ item.unit }}</td>
            <td>{{ "%.2f" | format(item.qty_wo) if item.qty_wo else "" }}</td>
            <td>{{ "%.2f" | format(item.rate) if item.rate else "" }}</td>
            <td>{{ "%.2f" | format(item.amt_wo) if item.amt_wo else "" }}</td>
            <td>{{ "%.2f" | format(item.qty_bill) if item.qty_bill else "" }}</td>
            <td>{{ "%.2f" | format(item.amt_bill) if item.amt_bill else "" }}</td>
            <td>{{ "%.2f" | format(item.excess_qty) if item.excess_qty else "" }}</td>
            <td>{{ "%.2f" | format(item.excess_amt) if item.excess_amt else "" }}</td>
            <td>{{ "%.2f" | format(item.saving_qty) if item.saving_qty else "" }}</td>
            <td>{{ "%.2f" | format(item.saving_amt) if item.saving_amt else "" }}</td>
            <td>{{ item.remark }}</td>
        </tr>
        {% endfor %}
        <tr>
            <td colspan="9"><strong>Summary</strong></td>
        </tr>
        <tr>
            <td colspan="5"><strong>Total Work Order Amount</strong></td>
            <td>{{ "%.2f" | format(totals.grand_total) if totals.grand_total else "" }}</td>
            <td colspan="7"></td>
        </tr>
        <tr>
            <td colspan="5"><strong>Tender Premium @ {{ "%.2f%%" | format((totals.tender_premium_percent or 0) * 100) }}</strong></td>
            <td>{{ "%.2f" | format(totals.tender_premium_amount or 0) }}</td>
            <td colspan="7"></td>
        </tr>
        <tr>
            <td colspan="5"><strong>Grand Total Work Order</strong></td>
            <td>{{ "%.2f" | format(totals.final_total or 0) }}</td>
            <td colspan="7"></td>
        </tr>
        <tr>
            <td colspan="7"><strong>Total Executed Amount</strong></td>
            <td>{{ "%.2f" | format(totals.grand_total or 0) }}</td>
            <td colspan="5"></td>
        </tr>
        <tr>
            <td colspan="7"><strong>Tender Premium @ {{ "%.2f%%" | format((totals.tender_premium_percent or 0) * 100) }}</strong></td>
            <td>{{ "%.2f" | format(totals.tender_premium_amount or 0) }}</td>
            <td colspan="5"></td>
        </tr>
        <tr>
            <td colspan="7"><strong>Grand Total Executed</strong></td>
            <td>{{ "%.2f" | format(totals.final_total or 0) }}</td>
            <td colspan="5"></td>
        </tr>
        <tr>
            <td colspan="9"><strong>Excess</strong></td>
        </tr>
        <tr>
            <td colspan="9"><strong>Total Excess Amount</strong></td>
            <td>{{ "%.2f" | format(totals.excess_amount or 0) }}</td>
            <td colspan="3"></td>
        </tr>
        <tr>
            <td colspan="9"><strong>Tender Premium @ {{ "%.2f%%" | format((totals.tender_premium_percent or 0) * 100) }}</strong></td>
            <td>{{ "%.2f" | format(totals.excess_premium or 0) }}</td>
            <td colspan="3"></td>
        </tr>
        <tr>
            <td colspan="9"><strong>Grand Total Excess</strong></td>
            <td>{{ "%.2f" | format(totals.excess_total or 0) }}</td>
            <td colspan="3"></td>
        </tr>
        <tr>
            <td colspan="11"><strong>Saving</strong></td>
        </tr>
        <tr>
            <td colspan="11"><strong>Total Saving Amount</strong></td>
            <td>{{ "%.2f" | format(totals.saving_amount or 0) }}</td>
        </tr>
        <tr>
            <td colspan="11"><strong>Tender Premium @ {{ "%.2f%%" | format((totals.tender_premium_percent or 0) * 100) }}</strong></td>
            <td>{{ "%.2f" | format(totals.saving_premium or 0) }}</td>
        </tr>
        <tr>
            <td colspan="11"><strong>Grand Total Saving</strong></td>
            <td>{{ "%.2f" | format(totals.saving_total or 0) }}</td>
        </tr>
        <tr>
            <td colspan="11"><strong>Net Difference</strong></td>
            <td>{{ "%.2f" | format(totals.net_difference or 0) }}</td>
        </tr>
    </table>
</body>
</html>